<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumina 3D | Cyber Grades</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
                    colors: {
                        cyber: { blue: '#00f3ff', purple: '#9d00ff', dark: '#0a0a0c', fail: '#ff003c', exc: '#00ff66' }
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700;900&display=swap');
        
        body {
            margin: 0; padding: 0; overflow: hidden;
            background: linear-gradient(135deg, #020203 0%, #111116 100%);
            color: white; font-family: 'Inter', sans-serif;
        }

        /* 3D Canvas Background */
        #webgl-canvas {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: -1; outline: none;
        }

        /* Glassmorphism Panels */
        .glass-panel {
            background: rgba(20, 20, 25, 0.4);
            backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }

        .glass-sub-panel {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Buttons & Inputs */
        .glass-button {
            background: rgba(0, 243, 255, 0.1); backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 243, 255, 0.3); color: white;
            transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .glass-button:hover { background: rgba(0, 243, 255, 0.2); box-shadow: 0 0 15px rgba(0, 243, 255, 0.4); }
        .glass-button.active { background: rgba(157, 0, 255, 0.2); border-color: rgba(157, 0, 255, 0.5); box-shadow: 0 0 15px rgba(157, 0, 255, 0.4); }

        .glass-input {
            background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.1);
            color: white; outline: none; transition: border-color 0.2s;
        }
        .glass-input:focus { border-color: #00f3ff; }

        /* Table Styling */
        .table-wrapper { overflow: auto; height: 100%; width: 100%; scrollbar-width: thin; scrollbar-color: #00f3ff rgba(0,0,0,0.2); }
        .table-wrapper::-webkit-scrollbar { width: 6px; height: 6px; }
        .table-wrapper::-webkit-scrollbar-thumb { background: #00f3ff; border-radius: 4px; }
        
        table { border-collapse: separate; border-spacing: 0; width: 100%; font-size: 0.95rem; table-layout: fixed; }
        th, td { padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.05); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        th {
            background: rgba(10, 10, 15, 0.85); /* Solid enough to hide scrolling rows underneath */
            backdrop-filter: blur(10px); position: sticky; top: 0; z-index: 20;
            text-align: left; font-weight: 600; color: #a1a1aa; user-select: none; cursor: pointer;
        }
        th:first-child { position: sticky; left: 0; top: 0; z-index: 30; border-right: 1px solid rgba(255,255,255,0.1); }
        
        td { cursor: pointer; color: #e4e4e7; transition: background 0.2s; }
        td:first-child { 
            position: sticky; left: 0; z-index: 15; background: rgba(10, 10, 15, 0.85);
            font-weight: 600; color: white; border-right: 1px solid rgba(255,255,255,0.1); 
        }

        tr:hover td { background: rgba(0, 243, 255, 0.05); }
        tr:hover td:first-child { background: rgba(0, 243, 255, 0.1); }
        tr.selected td { background: rgba(157, 0, 255, 0.15); color: #fff; }
        tr.selected td:first-child { background: rgba(157, 0, 255, 0.2); }

        /* Grade Highlights */
        .grade-fail { color: #ff003c; text-shadow: 0 0 8px rgba(255, 0, 60, 0.4); font-weight: 600; }
        .grade-exc { color: #00ff66; text-shadow: 0 0 8px rgba(0, 255, 102, 0.4); font-weight: 600; }

        /* Upload Zone */
        .upload-zone { border: 2px dashed rgba(0, 243, 255, 0.3); transition: all 0.3s; }
        .upload-zone.drag-over { border-color: #00f3ff; background: rgba(0, 243, 255, 0.05); transform: scale(0.99); }
        #fileInput { position: absolute; inset: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 10; }

        /* Resizer */
        .resizer { position: absolute; right: 0; top: 0; height: 100%; width: 4px; cursor: col-resize; z-index: 40; }
        .resizer:hover { background-color: #00f3ff; }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade { animation: fadeIn 0.4s ease forwards; }
    </style>
</head>
<body class="antialiased selection:bg-cyber-blue selection:text-black flex items-center justify-center min-h-screen p-4 md:p-8">

    <canvas id="webgl-canvas"></canvas>

    <main class="glass-panel w-full max-w-[1400px] h-[90vh] rounded-3xl p-6 flex flex-col gap-6 relative z-10 animate-fade">
        
        <header class="flex flex-col md:flex-row justify-between items-center gap-4 shrink-0">
            <h1 class="text-2xl md:text-3xl font-black tracking-widest text-transparent bg-clip-text bg-gradient-to-r from-white to-gray-500 uppercase">
                Lumina <span class="text-cyber-blue">3D</span>
            </h1>
            
            <div class="flex flex-wrap items-center gap-3">
                <div class="relative hidden md:block" id="searchBox" style="display: none;">
                    <span class="material-symbols-rounded absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm">search</span>
                    <input type="text" id="searchInput" placeholder="Search parameters..." class="glass-input h-10 w-64 rounded-full pl-10 pr-4 text-sm" />
                </div>
                
                <button class="glass-button h-10 px-4 rounded-full text-sm font-bold" id="statsBtn" style="display: none;">
                    <span class="material-symbols-rounded text-[20px]">bar_chart</span> Stats
                </button>
                <button class="glass-button h-10 w-10 rounded-full" id="colorBtn" style="display: none;">
                    <span class="material-symbols-rounded text-[20px]">palette</span>
                </button>
                <button class="glass-button h-10 px-4 rounded-full text-sm font-bold" id="resetBtn" style="display: none;">
                    <span class="material-symbols-rounded text-[20px]">upload_file</span> New
                </button>
            </div>
        </header>

        <div class="upload-zone grow rounded-2xl flex flex-col items-center justify-center relative bg-black/20" id="uploadZone">
            <span class="material-symbols-rounded text-6xl text-cyber-blue mb-4">memory</span>
            <h2 class="text-xl font-bold text-white tracking-wide">INITIALIZE DATA MATRIX</h2>
            <p class="text-gray-400 text-sm mt-2">Drop your .xlsx file here or click to browse</p>
            <input type="file" id="fileInput" accept=".xlsx" />
        </div>

        <div id="loadingZone" class="hidden grow flex-col justify-center items-center">
            <div class="w-12 h-12 border-4 border-cyber-purple border-t-cyber-blue rounded-full animate-spin mb-4"></div>
            <p class="text-cyber-blue tracking-widest text-sm animate-pulse">DECRYPTING DATA...</p>
        </div>

        <div id="statsDashboard" class="hidden grid-cols-2 md:grid-cols-4 gap-4 shrink-0">
            <div class="glass-sub-panel p-4 rounded-xl flex flex-col justify-center">
                <span class="text-xs text-gray-400 uppercase tracking-wider">Total Entities</span>
                <span class="text-2xl font-bold text-white" id="statTotal">0</span>
            </div>
            <div class="glass-sub-panel p-4 rounded-xl flex flex-col justify-center">
                <span class="text-xs text-gray-400 uppercase tracking-wider">Global Average</span>
                <div class="flex items-baseline gap-2">
                    <span class="text-2xl font-bold text-cyber-blue" id="statAvg">0%</span>
                    <span class="text-xs text-gray-500" id="statAvgSub">Score: 0</span>
                </div>
            </div>
            <div class="glass-sub-panel p-4 rounded-xl flex flex-col justify-center">
                <span class="text-xs text-gray-400 uppercase tracking-wider">Success Rate</span>
                <span class="text-2xl font-bold text-cyber-purple" id="statPass">0%</span>
            </div>
            <div class="glass-sub-panel p-4 rounded-xl flex flex-col justify-center">
                <span class="text-xs text-gray-400 uppercase tracking-wider">System Status</span>
                <span class="text-xl font-bold text-cyber-exc">OPTIMAL</span>
            </div>
        </div>

        <div id="dataContainer" class="hidden grow overflow-hidden rounded-xl glass-sub-panel border border-white/5">
            <div class="table-wrapper">
                <table id="gradesTable">
                    <thead id="tableHead"></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </main>

    <div id="modalOverlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden justify-center items-center opacity-0 transition-opacity duration-300">
        <div class="glass-panel w-[90%] max-w-[600px] max-h-[80vh] rounded-2xl p-6 flex flex-col shadow-[0_0_40px_rgba(0,243,255,0.1)] scale-95 transition-transform duration-300" id="modalCard">
            <div class="flex justify-between items-center mb-6 shrink-0">
                <h2 class="text-xl font-bold tracking-wide text-white">Entity Details</h2>
                <button id="modalClose" class="text-gray-400 hover:text-white transition-colors">
                    <span class="material-symbols-rounded">close</span>
                </button>
            </div>
            <div id="modalContent" class="grid grid-cols-2 gap-4 overflow-y-auto pr-2 pb-2 scrollbar-thin">
                </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 glass-panel px-6 py-3 rounded-full text-sm font-bold tracking-wide text-white opacity-0 transition-opacity duration-300 pointer-events-none z-50 shadow-[0_0_20px_rgba(0,243,255,0.3)] border-cyber-blue/30">
        System Initialized
    </div>

    <script type="module">
        import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';

        const canvas = document.querySelector('#webgl-canvas');
        const scene = new THREE.Scene();
        const cameraGroup = new THREE.Group();
        scene.add(cameraGroup);

        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.z = 18;
        cameraGroup.add(camera);

        const renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(1); // Optimized for performance
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.2;

        const geometry = new THREE.TorusKnotGeometry(4, 1.2, 80, 24);
        const material = new THREE.MeshPhysicalMaterial({
            color: 0x111111, metalness: 0.6, roughness: 0.3, transmission: 0.9, ior: 1.5
        });

        const torusKnot = new THREE.Mesh(geometry, material);
        scene.add(torusKnot);

        const blueLight = new THREE.DirectionalLight(0x00f3ff, 4);
        blueLight.position.set(5, 5, 5);
        scene.add(blueLight);

        const purpleLight = new THREE.PointLight(0x9d00ff, 15, 50);
        purpleLight.position.set(-5, -3, 2);
        scene.add(purpleLight);

        const rimLight = new THREE.SpotLight(0xe0ffff, 10);
        rimLight.position.set(0, 5, -10);
        rimLight.lookAt(torusKnot.position);
        scene.add(rimLight);
        
        scene.add(new THREE.AmbientLight(0x111116, 0.5));

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        const clock = new THREE.Clock();
        let targetX = 0, targetY = 0;
        const windowHalfX = window.innerWidth / 2, windowHalfY = window.innerHeight / 2;

        document.addEventListener('mousemove', (event) => {
            targetX = (event.clientX - windowHalfX) * 0.001;
            targetY = (event.clientY - windowHalfY) * 0.001;
        });

        function animate() {
            requestAnimationFrame(animate);
            const elapsedTime = clock.getElapsedTime();

            torusKnot.rotation.x = elapsedTime * 0.15;
            torusKnot.rotation.y = elapsedTime * 0.2;

            camera.position.x = Math.sin(elapsedTime * 0.5) * 0.5;
            camera.position.y = Math.cos(elapsedTime * 0.3) * 0.5;
            
            cameraGroup.position.x += (targetX - cameraGroup.position.x) * 0.02;
            cameraGroup.position.y += (-targetY - cameraGroup.position.y) * 0.02;

            purpleLight.intensity = 15 + Math.sin(elapsedTime * 2) * 5;
            renderer.render(scene, camera);
        }
        animate();
    </script>

    <script>
        // Data config map matching your original logic
        const SUBJECT_CONFIG = {
            "اللغة العربية": 80, "arabic": 80, "arb": 80, "اللغة الأولى": 60, "english": 60, "eng": 60,
            "التاريخ": 60, "history": 60, "hist": 60, "الرياضيات": 60, "math": 60, "mathematics": 60, "جبر": 60, "هندسة": 60,
            "الكيمياء": 60, "chemistry": 60, "chem": 60, "الفيزياء": 60, "physics": 60, "phys": 60,
            "الأحياء": 60, "biology": 60, "bio": 60, "الجغرافيا": 60, "geography": 60, "geo": 60,
            "الفلسفة": 60, "philosophy": 60, "phil": 60, "علم النفس": 60, "psychology": 60, "psy": 60,
            "تربية دينية": 40, "religion": 40, "rel": 40, "لغة اجنبية ثانية": 40, "french": 40, "german": 40, "italian": 40, "spanish": 40,
            "تربية وطنية": 25, "national": 25, "اقتصاد وإحصاء": 50, "economics": 50, "stats": 50,
            "الجيولوجيا": 60, "geology": 60, "المجموع": 410, "total": 410
        };

        let globalData = [], currentData = [], headers = [], colWidths = [];
        let useColors = true, showStats = false, selectedRow = null;
        let sortCol = -1, sortAsc = true;

        const els = {
            fileInput: document.getElementById('fileInput'),
            uploadZone: document.getElementById('uploadZone'),
            loadingZone: document.getElementById('loadingZone'),
            dataContainer: document.getElementById('dataContainer'),
            thead: document.getElementById('tableHead'),
            tbody: document.getElementById('tableBody'),
            searchBox: document.getElementById('searchBox'),
            searchInput: document.getElementById('searchInput'),
            statsBtn: document.getElementById('statsBtn'),
            colorBtn: document.getElementById('colorBtn'),
            resetBtn: document.getElementById('resetBtn'),
            statsDashboard: document.getElementById('statsDashboard'),
            toast: document.getElementById('toast'),
            modalOverlay: document.getElementById('modalOverlay'),
            modalCard: document.getElementById('modalCard'),
            modalClose: document.getElementById('modalClose'),
            modalContent: document.getElementById('modalContent')
        };

        function getMaxGrade(colName) {
            if (!colName) return null;
            const cleanName = colName.trim().toLowerCase();
            if (SUBJECT_CONFIG[cleanName]) return SUBJECT_CONFIG[cleanName];
            for (const key in SUBJECT_CONFIG) if (cleanName.includes(key)) return SUBJECT_CONFIG[key];
            return null;
        }

        // Drag & Drop
        ['dragenter', 'dragover'].forEach(e => els.uploadZone.addEventListener(e, (ev) => { ev.preventDefault(); els.uploadZone.classList.add('drag-over'); }));
        ['dragleave', 'drop'].forEach(e => els.uploadZone.addEventListener(e, (ev) => { ev.preventDefault(); els.uploadZone.classList.remove('drag-over'); }));
        els.uploadZone.addEventListener('drop', (e) => handleFile(e.dataTransfer.files[0]));
        els.fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));

        const handleFile = (file) => {
            if (!file || !file.name.endsWith('.xlsx')) return showToast('DATA CORRUPT: Require .xlsx');
            
            els.uploadZone.style.display = 'none';
            els.loadingZone.classList.remove('hidden');
            els.loadingZone.classList.add('flex');

            const reader = new FileReader();
            reader.onload = (e) => {
                setTimeout(() => {
                    try {
                        const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                        const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1, defval: "" });
                        if (rawData.length === 0) throw new Error();

                        headers = rawData[0];
                        globalData = rawData.slice(1);
                        currentData = [...globalData];
                        colWidths = new Array(headers.length).fill(160);

                        renderHeader();
                        renderBody();

                        els.loadingZone.classList.add('hidden');
                        els.loadingZone.classList.remove('flex');
                        els.dataContainer.classList.remove('hidden');
                        els.dataContainer.classList.add('flex');
                        
                        els.searchBox.style.display = 'block';
                        els.statsBtn.style.display = 'flex';
                        els.colorBtn.style.display = 'flex';
                        els.resetBtn.style.display = 'flex';
                        
                        showToast(`MATRIX LOADED: ${globalData.length} records`);
                    } catch (err) { location.reload(); }
                }, 800); 
            };
            reader.readAsArrayBuffer(file);
        };

        const renderHeader = () => {
            els.thead.innerHTML = '';
            const tr = document.createElement('tr');
            headers.forEach((text, i) => {
                const th = document.createElement('th');
                th.innerHTML = `${text} <div class="resizer"></div>`;
                th.style.width = colWidths[i] + 'px';
                th.onclick = (e) => { if (!e.target.classList.contains('resizer')) handleSort(i); };
                
                // Resizer logic
                const resizer = th.querySelector('.resizer');
                let startX, startW;
                const mouseMove = (e) => { th.style.width = Math.max(80, startW + (e.clientX - startX)) + 'px'; colWidths[i] = parseInt(th.style.width); };
                const mouseUp = () => { document.removeEventListener('mousemove', mouseMove); document.removeEventListener('mouseup', mouseUp); };
                resizer.onmousedown = (e) => { e.stopPropagation(); startX = e.clientX; startW = th.offsetWidth; document.addEventListener('mousemove', mouseMove); document.addEventListener('mouseup', mouseUp); };

                tr.appendChild(th);
            });
            els.thead.appendChild(tr);
        };

        const renderBody = () => {
            els.tbody.innerHTML = '';
            const frag = document.createDocumentFragment();
            const displayData = currentData.slice(0, 300); // Limit DOM nodes for perf

            displayData.forEach(row => {
                const tr = document.createElement('tr');
                tr.onclick = () => {
                    if(selectedRow) selectedRow.classList.remove('selected');
                    tr.classList.add('selected');
                    selectedRow = tr;
                    openModal(row);
                };

                headers.forEach((h, i) => {
                    const td = document.createElement('td');
                    const val = row[i];
                    const max = getMaxGrade(h);
                    const isNum = !isNaN(parseFloat(val)) && isFinite(val) && val !== "";
                    
                    if (isNum) {
                        td.style.textAlign = 'right';
                        td.textContent = max ? `${val} / ${max}` : val;
                        if (useColors) {
                            let pct = max ? (parseFloat(val)/max)*100 : (parseFloat(val)<50 ? 49 : 100);
                            if (pct < 50) td.className = 'grade-fail';
                            else if (pct >= 90) td.className = 'grade-exc';
                        }
                    } else {
                        td.textContent = val || "";
                    }
                    tr.appendChild(td);
                });
                frag.appendChild(tr);
            });
            els.tbody.appendChild(frag);
            if(showStats) calculateStats();
        };

        const handleSort = (idx) => {
            if (sortCol === idx) sortAsc = !sortAsc; else { sortCol = idx; sortAsc = true; }
            currentData.sort((a,b) => {
                let va = a[sortCol], vb = b[sortCol];
                let na = parseFloat(va), nb = parseFloat(vb);
                if (!isNaN(na) && !isNaN(nb) && va!=="" && vb!=="") return sortAsc ? na - nb : nb - na;
                return sortAsc ? String(va).localeCompare(String(vb)) : String(vb).localeCompare(String(va));
            });
            renderBody();
        };

        // Modal Logic
        const openModal = (row) => {
            els.modalContent.innerHTML = '';
            headers.forEach((h, i) => {
                const val = row[i];
                if (val !== "" && val !== null) {
                    const max = getMaxGrade(h);
                    const isNum = !isNaN(parseFloat(val)) && isFinite(val);
                    let valClass = 'text-white font-bold text-lg';
                    let barHTML = '';

                    if (isNum && max) {
                        let pct = (parseFloat(val)/max)*100;
                        let barColor = 'bg-cyber-blue';
                        if (useColors) {
                            if (pct < 50) { valClass = 'grade-fail text-lg'; barColor = 'bg-cyber-fail shadow-[0_0_10px_#ff003c]'; }
                            else if (pct >= 90) { valClass = 'grade-exc text-lg'; barColor = 'bg-cyber-exc shadow-[0_0_10px_#00ff66]'; }
                        }
                        barHTML = `<div class="w-full h-1.5 bg-white/10 rounded-full mt-2 overflow-hidden"><div class="h-full ${barColor}" style="width: ${pct}%"></div></div>`;
                    }

                    const item = document.createElement('div');
                    item.className = 'glass-sub-panel p-3 rounded-xl flex flex-col';
                    item.innerHTML = `
                        <span class="text-xs text-gray-400 mb-1 truncate">${h}</span>
                        <span class="${valClass}">${isNum && max ? val + ' <span class="text-xs text-gray-500">/ ' + max + '</span>' : val}</span>
                        ${barHTML}
                    `;
                    els.modalContent.appendChild(item);
                }
            });
            els.modalOverlay.classList.remove('hidden');
            els.modalOverlay.classList.add('flex');
            setTimeout(() => { els.modalOverlay.classList.remove('opacity-0'); els.modalCard.classList.remove('scale-95'); }, 10);
        };

        const closeModal = () => {
            els.modalOverlay.classList.add('opacity-0');
            els.modalCard.classList.add('scale-95');
            setTimeout(() => { els.modalOverlay.classList.add('hidden'); els.modalOverlay.classList.remove('flex'); }, 300);
            if(selectedRow) selectedRow.classList.remove('selected');
        };
        els.modalClose.onclick = closeModal;
        els.modalOverlay.onclick = (e) => { if(e.target === els.modalOverlay) closeModal(); };

        // UI Interactions
        els.searchInput.oninput = (e) => {
            const term = e.target.value.toLowerCase();
            currentData = term ? globalData.filter(r => r.some(c => String(c).toLowerCase().includes(term))) : [...globalData];
            renderBody();
        };

        els.statsBtn.onclick = () => {
            showStats = !showStats;
            els.statsBtn.classList.toggle('active');
            if(showStats) { els.statsDashboard.classList.remove('hidden'); els.statsDashboard.classList.add('grid'); calculateStats(); }
            else { els.statsDashboard.classList.add('hidden'); els.statsDashboard.classList.remove('grid'); }
        };

        els.colorBtn.onclick = () => { useColors = !useColors; els.colorBtn.classList.toggle('active'); renderBody(); };
        els.resetBtn.onclick = () => location.reload();

        function calculateStats() {
            if (currentData.length === 0) return;
            document.getElementById('statTotal').textContent = currentData.length;
            
            let totalIdx = headers.findIndex(h => ['total','المجموع','score'].includes(h.toLowerCase().trim()));
            if (totalIdx > -1) {
                let sum=0, count=0, pass=0;
                const max = getMaxGrade(headers[totalIdx]) || 410;
                currentData.forEach(r => {
                    let v = parseFloat(r[totalIdx]);
                    if (!isNaN(v)) { sum+=v; count++; if (v/max >= 0.5) pass++; }
                });
                if (count) {
                    document.getElementById('statAvg').textContent = ((sum/count/max)*100).toFixed(1) + "%";
                    document.getElementById('statAvgSub').textContent = `Avg: ${(sum/count).toFixed(1)}`;
                    document.getElementById('statPass').textContent = ((pass/count)*100).toFixed(1) + "%";
                }
            }
        }

        function showToast(msg) {
            els.toast.textContent = msg;
            els.toast.classList.remove('opacity-0');
            setTimeout(() => els.toast.classList.add('opacity-0'), 3000);
        }
    </script>
</body>
</html>
